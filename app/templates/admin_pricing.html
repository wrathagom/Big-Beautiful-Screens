<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing - Big Beautiful Screens</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/admin.css">
    {% if clerk_publishable_key %}
    <script
        data-clerk-publishable-key="{{ clerk_publishable_key }}"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        async
    ></script>
    {% endif %}
    <script async src="https://js.stripe.com/v3/pricing-table.js"></script>
    <style>
        .pricing-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .pricing-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .pricing-header h1 {
            margin: 0 0 0.5rem 0;
        }
        .pricing-header p {
            color: #888;
            margin: 0;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 1.5rem;
            color: #4a69bd;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        #pricing-table-container {
            width: 100%;
            min-height: 400px;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        .error {
            text-align: center;
            padding: 2rem;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="pricing-container">
        <a href="/admin/usage" class="back-link">&larr; Back to Usage & Billing</a>

        <div class="pricing-header">
            <h1>Choose Your Plan</h1>
            <p>Select the plan that best fits your needs</p>
        </div>

        <div id="pricing-table-container">
            <div class="loading">Loading pricing options...</div>
        </div>
    </div>

    <script>
        async function signOut() {
            if (typeof Clerk !== 'undefined' && Clerk.loaded) {
                await Clerk.signOut();
            }
            window.location.href = '/auth/logout';
        }

        // Helper to get Clerk session token for API calls
        async function getAuthHeaders() {
            if (typeof Clerk === 'undefined') return {};
            if (!Clerk.loaded) await Clerk.load();
            if (!Clerk.session) return {};
            try {
                const token = await Clerk.session.getToken();
                if (token) return { 'Authorization': `Bearer ${token}` };
            } catch (e) {
                console.error('[Auth] Error getting token:', e);
            }
            return {};
        }

        async function initPricingTable() {
            const container = document.getElementById('pricing-table-container');

            try {
                // Get customer session from our API
                const authHeaders = await getAuthHeaders();
                const response = await fetch('/api/v1/billing/customer-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to initialize billing session');
                }

                const data = await response.json();

                // Create pricing table with customer session
                const pricingTable = document.createElement('stripe-pricing-table');
                pricingTable.setAttribute('pricing-table-id', '{{ stripe_pricing_table_id }}');
                pricingTable.setAttribute('publishable-key', '{{ stripe_publishable_key }}');
                pricingTable.setAttribute('customer-session-client-secret', data.client_secret);

                container.innerHTML = '';
                container.appendChild(pricingTable);

            } catch (error) {
                console.error('Error initializing pricing table:', error);
                container.innerHTML = '<div class="error">Failed to load pricing. Please try again or <a href="/admin/usage">go back</a>.</div>';
            }
        }

        // Wait for Clerk to be ready, then init
        if (typeof Clerk !== 'undefined') {
            Clerk.load().then(() => initPricingTable());
        } else {
            // Fallback if Clerk isn't loaded
            window.addEventListener('load', () => {
                setTimeout(initPricingTable, 500);
            });
        }
    </script>

    <!-- Help Button -->
    <div class="help-container">
        <span class="help-text">{{ help_text }}</span>
        <a href="{{ help_url }}" target="_blank" class="help-button" title="Get Help">?</a>
    </div>
</body>
</html>
