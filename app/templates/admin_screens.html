<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Beautiful Screens - Admin</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/admin.css">
    {% if clerk_publishable_key %}
    <script
        data-clerk-publishable-key="{{ clerk_publishable_key }}"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        async
    ></script>
    {% endif %}
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <div class="header-title">
                <img src="/static/logo.png" alt="BBS Logo" class="header-logo">
                <div>
                    <h1>Big Beautiful Screens</h1>
                    <p class="subtitle">Admin Dashboard</p>
                </div>
            </div>
        </div>

        <div class="actions">
            <button id="create-screen" class="btn-primary">+ Create New Screen</button>
            <div class="nav-links">
                <a href="/admin/themes" class="nav-link">Themes</a>
                <a href="/admin/usage" class="nav-link">Usage & Billing</a>
                <a href="/docs" class="nav-link" target="_blank">API Docs</a>
                {% if clerk_publishable_key %}
                <a href="#" class="nav-link" onclick="signOut(); return false;">Sign Out</a>
                {% endif %}
            </div>
        </div>

        <div class="screen-list">
            {% if screens %}
                {% for screen in screens %}
                <div class="screen-card" data-screen-id="{{ screen.id }}" data-api-key="{{ screen.api_key }}" data-screen-url="{{ screen.screen_url }}" data-api-url="{{ screen.api_url }}">
                    <div class="card-header" onclick="toggleExpand(this.parentElement)">
                        <div class="card-summary">
                            <span class="screen-name {{ 'unnamed' if screen.is_unnamed else '' }}" onclick="editName(this, event)" title="Click to edit name">{{ screen.name_display }}</span>
                            <code class="screen-id">{{ screen.id }}</code>
                            <a href="{{ screen.screen_url }}" target="_blank" class="screen-link" onclick="event.stopPropagation()">
                                <span class="link-icon">‚Üó</span> <span class="screen-link-text">{{ screen.screen_url }}</span>
                            </a>
                            <span class="viewer-badge">{{ screen.viewer_count }} viewer{{ 's' if screen.viewer_count != 1 else '' }}</span>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="card-details">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>API Key</label>
                                <div class="detail-value">
                                    <code class="api-key">{{ screen.api_key }}</code>
                                    <button class="btn-icon copy-api-key" onclick="copyValue(this, '{{ screen.api_key }}')" title="Copy API Key">üìã</button>
                                </div>
                            </div>
                            <div class="detail-item">
                                <label>API Endpoint</label>
                                <div class="detail-value">
                                    <code class="api-url">{{ screen.api_url }}</code>
                                    <button class="btn-icon copy-api-url" onclick="copyValue(this, BASE_URL + '{{ screen.api_url }}')" title="Copy API URL">üìã</button>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <label>Custom Head HTML <span class="hint">(for Google Fonts, etc.)</span></label>
                            <textarea class="head-html-input" placeholder="<link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;>
<link href=&quot;https://fonts.googleapis.com/css2?family=...&quot; rel=&quot;stylesheet&quot;>" onclick="event.stopPropagation()">{{ screen.head_html or '' }}</textarea>
                            <p class="warning-text">Warning: Custom HTML including scripts is injected directly into your screen. Only add code from sources you trust.</p>
                            <button class="btn-secondary btn-save-head" onclick="saveHeadHtml('{{ screen.id }}', this); event.stopPropagation();">Save Head HTML</button>
                        </div>
                        <div class="detail-footer">
                            <div class="detail-timestamps">
                                <span>Created: <span class="created-time">{{ screen.created_display }}</span></span>
                                <span>Last Updated: <span class="updated-time">{{ screen.last_updated_display }}</span></span>
                            </div>
                            <div class="detail-actions">
                                <div class="copy-dropdown">
                                    <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Copy Example ‚ñæ</button>
                                    <div class="dropdown-menu">
                                        <button onclick="copyExample(this, 'bash')">Bash / cURL</button>
                                        <button onclick="copyExample(this, 'python')">Python</button>
                                    </div>
                                </div>
                                <button class="btn-secondary" onclick="viewJson('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">View JSON</button>
                                <button class="btn-debug" onclick="toggleDebug('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Toggle Debug</button>
                                <button class="btn-reload" onclick="reloadScreen('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Reload Viewers</button>
                                <button class="btn-delete" onclick="deleteScreen('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Delete Screen</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty">No screens yet. Create one to get started!</div>
            {% endif %}
        </div>

        {% if total_pages > 1 %}
        <div class="pagination">
            <span class="page-info">Page {{ page }} of {{ total_pages }} ({{ total_count }} screens)</span>
            <div class="page-controls">
                <a href="?page={{ page - 1 }}" class="btn-secondary{{ ' disabled' if page <= 1 else '' }}">‚Üê Previous</a>
                <a href="?page={{ page + 1 }}" class="btn-secondary{{ ' disabled' if page >= total_pages else '' }}">Next ‚Üí</a>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        const BASE_URL = window.location.origin;

        // Helper to get Clerk session token for API calls (SaaS mode)
        // Returns empty headers in self-hosted mode where Clerk isn't loaded
        async function getAuthHeaders() {
            if (typeof Clerk === 'undefined') return {};

            // Wait for Clerk to be ready if needed
            if (!Clerk.loaded) await Clerk.load();
            if (!Clerk.session) return {};

            try {
                const token = await Clerk.session.getToken();
                if (token) {
                    return { 'Authorization': `Bearer ${token}` };
                }
            } catch (e) {
                console.error('[Auth] Error getting token:', e);
            }
            return {};
        }

        async function signOut() {
            if (typeof Clerk !== 'undefined' && Clerk.loaded) {
                await Clerk.signOut();
            }
            window.location.href = '/auth/logout';
        }

        document.getElementById('create-screen').addEventListener('click', async () => {
            const authHeaders = await getAuthHeaders();
            const response = await fetch('/api/v1/screens', {
                method: 'POST',
                headers: authHeaders,
                credentials: 'include'
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                alert(error.detail || 'Failed to create screen. Please try refreshing the page.');
                return;
            }
            const data = await response.json();

            // Create and insert new screen card
            const screenList = document.querySelector('.screen-list');
            const emptyMessage = screenList.querySelector('.empty');
            if (emptyMessage) emptyMessage.remove();

            const card = createScreenCard(data);
            screenList.insertBefore(card, screenList.firstChild);
            card.classList.add('expanded');
        });

        function createScreenCard(data) {
            const template = document.getElementById('screen-card-template');
            const card = template.content.firstElementChild.cloneNode(true);

            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

            // Set data attributes
            card.dataset.screenId = data.screen_id;
            card.dataset.apiKey = data.api_key;
            card.dataset.screenUrl = data.screen_url;
            card.dataset.apiUrl = data.api_url;

            // Update content
            card.querySelector('.screen-id').textContent = data.screen_id;
            card.querySelector('.screen-link').href = data.screen_url;
            card.querySelector('.screen-link-text').textContent = data.screen_url;
            card.querySelector('.api-key').textContent = data.api_key;
            card.querySelector('.api-url').textContent = data.api_url;
            card.querySelector('.created-time').textContent = now;

            // Update onclick handlers with actual values
            card.querySelector('.copy-api-key').onclick = function() { copyValue(this, data.api_key); };
            card.querySelector('.copy-api-url').onclick = function() { copyValue(this, BASE_URL + data.api_url); };
            card.querySelector('.btn-save-head').onclick = function(e) { e.stopPropagation(); saveHeadHtml(data.screen_id, this); };
            card.querySelector('.btn-view-json').onclick = function(e) { e.stopPropagation(); viewJson(data.screen_id, data.api_key); };
            card.querySelector('.btn-debug').onclick = function(e) { e.stopPropagation(); toggleDebug(data.screen_id, data.api_key); };
            card.querySelector('.btn-reload').onclick = function(e) { e.stopPropagation(); reloadScreen(data.screen_id, data.api_key); };
            card.querySelector('.btn-delete').onclick = function(e) { e.stopPropagation(); deleteScreen(data.screen_id, data.api_key); };

            return card;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.copy-dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        function toggleExpand(card) {
            card.classList.toggle('expanded');
        }

        function toggleDropdown(btn) {
            const menu = btn.nextElementSibling;
            const wasOpen = menu.classList.contains('show');

            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                m.classList.remove('show');
            });

            // Toggle this one
            if (!wasOpen) {
                menu.classList.add('show');
            }
        }

        function getCardData(el) {
            const card = el.closest('.screen-card');
            return {
                screenId: card.dataset.screenId,
                apiKey: card.dataset.apiKey,
                screenUrl: card.dataset.screenUrl,
                apiUrl: card.dataset.apiUrl
            };
        }

        function copyValue(btn, value) {
            navigator.clipboard.writeText(value).then(() => {
                const original = btn.textContent;
                btn.textContent = '‚úì';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('copied');
                }, 1000);
            });
            event.stopPropagation();
        }

        function copyExample(btn, type) {
            const data = getCardData(btn);
            let text = '';

            if (type === 'bash') {
                text = `curl -X POST ${BASE_URL}${data.apiUrl} \\
  -H "Content-Type: application/json" \\
  -H "X-API-Key: ${data.apiKey}" \\
  -d '{"content": ["Hello, World!"]}'`;
            } else if (type === 'python') {
                text = `import requests

response = requests.post(
    "${BASE_URL}${data.apiUrl}",
    headers={"X-API-Key": "${data.apiKey}"},
    json={"content": ["Hello, World!"]}
)
print(response.json())`;
            }

            navigator.clipboard.writeText(text).then(() => {
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('copied');
                    btn.closest('.dropdown-menu').classList.remove('show');
                }, 1000);
            });
            event.stopPropagation();
        }

        async function reloadScreen(screenId, apiKey) {
            try {
                const response = await fetch(`/api/v1/screens/${screenId}/reload`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Reload sent to ${data.viewers_reloaded} viewer(s)`);
                } else {
                    alert('Failed to reload: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to reload: ' + error.message);
            }
        }

        async function viewJson(screenId, apiKey) {
            try {
                const response = await fetch(`/api/v1/screens/${screenId}`, {
                    headers: { 'X-API-Key': apiKey }
                });
                if (!response.ok) {
                    alert('Failed to fetch screen data');
                    return;
                }
                const data = await response.json();
                const modal = document.getElementById('json-modal');
                const content = document.getElementById('json-content');
                content.textContent = JSON.stringify(data, null, 2);
                modal.style.display = 'flex';
            } catch (error) {
                alert('Failed to fetch: ' + error.message);
            }
        }

        function closeJsonModal() {
            document.getElementById('json-modal').style.display = 'none';
        }

        function copyJson() {
            const content = document.getElementById('json-content').textContent;
            navigator.clipboard.writeText(content);
            const btn = document.querySelector('#json-modal .btn-primary');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy JSON', 1500);
        }

        // Track debug state per screen
        const debugState = {};

        async function toggleDebug(screenId, apiKey) {
            // Toggle the state
            debugState[screenId] = !debugState[screenId];
            const enabled = debugState[screenId];

            try {
                const response = await fetch(`/api/v1/screens/${screenId}/debug?enabled=${enabled}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(`Debug ${enabled ? 'enabled' : 'disabled'} for ${data.viewers} viewer(s)`);
                } else {
                    alert('Failed to toggle debug: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to toggle debug: ' + error.message);
            }
        }

        async function deleteScreen(screenId, apiKey) {
            if (!confirm('Are you sure you want to delete this screen? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/screens/${screenId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });
                if (response.ok) {
                    // Remove card from DOM
                    const card = document.querySelector(`[data-screen-id="${screenId}"]`);
                    if (card) {
                        card.remove();
                        // Show empty message if no screens left
                        const screenList = document.querySelector('.screen-list');
                        if (!screenList.querySelector('.screen-card')) {
                            screenList.innerHTML = '<div class="empty">No screens yet. Create one to get started!</div>';
                        }
                    }
                } else {
                    const data = await response.json();
                    alert('Failed to delete screen: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete screen: ' + error.message);
            }
        }

        async function saveHeadHtml(screenId, btn) {
            const card = btn.closest('.screen-card');
            const apiKey = card.dataset.apiKey;
            const textarea = card.querySelector('.head-html-input');
            const headHtml = textarea.value;

            try {
                btn.disabled = true;
                btn.textContent = 'Saving...';

                const response = await fetch(`/api/v1/screens/${screenId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ head_html: headHtml })
                });

                if (response.ok) {
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.textContent = 'Save Head HTML';
                        btn.disabled = false;
                    }, 1500);
                } else {
                    const data = await response.json();
                    alert('Failed to save: ' + (data.detail || 'Unknown error'));
                    btn.textContent = 'Save Head HTML';
                    btn.disabled = false;
                }
            } catch (error) {
                alert('Failed to save: ' + error.message);
                btn.textContent = 'Save Head HTML';
                btn.disabled = false;
            }
        }

        function editName(el, event) {
            event.stopPropagation();
            const card = el.closest('.screen-card');
            const screenId = card.dataset.screenId;
            const currentName = el.classList.contains('unnamed') ? '' : el.textContent;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'name-input';
            input.value = currentName;
            input.placeholder = 'Enter screen name...';

            const saveName = async () => {
                const newName = input.value.trim();
                try {
                    const response = await fetch(`/api/v1/screens/${screenId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName || null })
                    });
                    if (response.ok) {
                        el.textContent = newName || 'Unnamed Screen';
                        el.classList.toggle('unnamed', !newName);
                    }
                } catch (error) {
                    console.error('Failed to update name:', error);
                }
                input.replaceWith(el);
            };

            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });

            el.replaceWith(input);
            input.focus();
            input.select();
        }
    </script>

    <!-- JSON View Modal -->
    <div id="json-modal" class="modal" onclick="if(event.target === this) closeJsonModal()">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Screen Data (JSON)</h2>
                <button class="modal-close" onclick="closeJsonModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="json-content" class="json-display"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeJsonModal()">Close</button>
                <button class="btn-primary" onclick="copyJson()">Copy JSON</button>
            </div>
        </div>
    </div>

    <!-- Template for new screen cards (cloned by JavaScript) -->
    <template id="screen-card-template">
        <div class="screen-card">
            <div class="card-header" onclick="toggleExpand(this.parentElement)">
                <div class="card-summary">
                    <span class="screen-name unnamed" onclick="editName(this, event)" title="Click to edit name">Unnamed Screen</span>
                    <code class="screen-id"></code>
                    <a href="#" target="_blank" class="screen-link" onclick="event.stopPropagation()">
                        <span class="link-icon">‚Üó</span> <span class="screen-link-text"></span>
                    </a>
                    <span class="viewer-badge">0 viewers</span>
                </div>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="card-details">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>API Key</label>
                        <div class="detail-value">
                            <code class="api-key"></code>
                            <button class="btn-icon copy-api-key" title="Copy API Key">üìã</button>
                        </div>
                    </div>
                    <div class="detail-item">
                        <label>API Endpoint</label>
                        <div class="detail-value">
                            <code class="api-url"></code>
                            <button class="btn-icon copy-api-url" title="Copy API URL">üìã</button>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <label>Custom Head HTML <span class="hint">(for Google Fonts, etc.)</span></label>
                    <textarea class="head-html-input" placeholder="<link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;>
<link href=&quot;https://fonts.googleapis.com/css2?family=...&quot; rel=&quot;stylesheet&quot;>" onclick="event.stopPropagation()"></textarea>
                    <p class="warning-text">Warning: Custom HTML including scripts is injected directly into your screen. Only add code from sources you trust.</p>
                    <button class="btn-secondary btn-save-head" onclick="event.stopPropagation();">Save Head HTML</button>
                </div>
                <div class="detail-footer">
                    <div class="detail-timestamps">
                        <span>Created: <span class="created-time"></span></span>
                        <span>Last Updated: <span class="updated-time">Never</span></span>
                    </div>
                    <div class="detail-actions">
                        <div class="copy-dropdown">
                            <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Copy Example ‚ñæ</button>
                            <div class="dropdown-menu">
                                <button onclick="copyExample(this, 'bash')">Bash / cURL</button>
                                <button onclick="copyExample(this, 'python')">Python</button>
                            </div>
                        </div>
                        <button class="btn-secondary btn-view-json" onclick="event.stopPropagation();">View JSON</button>
                        <button class="btn-debug" onclick="event.stopPropagation();">Toggle Debug</button>
                        <button class="btn-reload" onclick="event.stopPropagation();">Reload Viewers</button>
                        <button class="btn-delete" onclick="event.stopPropagation();">Delete Screen</button>
                    </div>
                </div>
            </div>
        </div>
    </template>
</body>
</html>
