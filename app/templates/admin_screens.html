<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Beautiful Screens - Admin</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/admin.css">
    {% if clerk_publishable_key %}
    <script
        data-clerk-publishable-key="{{ clerk_publishable_key }}"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        async
    ></script>
    {% endif %}
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <div class="header-title">
                <img src="/static/logo.png" alt="BBS Logo" class="header-logo">
                <div>
                    <h1>Big Beautiful Screens</h1>
                    <p class="subtitle">Admin Dashboard</p>
                </div>
            </div>
        </div>

        <div class="actions">
            <button id="create-screen" class="btn-primary">+ Create New Screen</button>
            <div class="nav-links">
                <div class="nav-dropdown">
                    <button class="nav-link" onclick="toggleNavDropdown(this)">Menu &#9662;</button>
                    <div class="nav-dropdown-menu">
                        <a href="/admin/screens" class="active">Screens</a>
                        <a href="/admin/templates">Templates</a>
                        <a href="/admin/themes">Themes</a>
                        <a href="/admin/media">Media</a>
                        {% if clerk_publishable_key %}
                        <a href="/admin/usage">Usage & Billing</a>
                        <a href="/admin/api-keys">API Keys</a>
                        {% endif %}
                    </div>
                </div>
                {% if clerk_publishable_key %}
                <button class="btn-delete" onclick="signOut()">Sign Out</button>
                {% endif %}
            </div>
        </div>

        <div class="screen-list">
            {% if screens %}
                {% for screen in screens %}
                <div class="screen-card" data-screen-id="{{ screen.id }}" data-api-key="{{ screen.api_key }}" data-screen-url="{{ screen.screen_url }}" data-api-url="{{ screen.api_url }}">
                    <div class="card-header" onclick="toggleExpand(this.parentElement)">
                        <div class="card-summary">
                            <span class="screen-name {{ 'unnamed' if screen.is_unnamed else '' }}" onclick="editName(this, event)" title="Click to edit name">{{ screen.name_display }}</span>
                            <code class="screen-id">{{ screen.id }}</code>
                            <a href="{{ screen.screen_url }}" target="_blank" class="screen-link" onclick="event.stopPropagation()">
                                <span class="link-icon">‚Üó</span> <span class="screen-link-text">{{ screen.screen_url }}</span>
                            </a>
                            {% if screen.name_display == 'Welcome Demo' %}
                            <span class="demo-indicator" onclick="event.stopPropagation()">
                                <span class="demo-indicator-arrow">üëà</span>
                                <span class="demo-indicator-text">Click to view demo!</span>
                            </span>
                            {% endif %}
                            <span class="viewer-badge">{{ screen.viewer_count }} viewer{{ 's' if screen.viewer_count != 1 else '' }}</span>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="card-details">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>API Key</label>
                                <div class="detail-value">
                                    <code class="api-key">{{ screen.api_key }}</code>
                                    <button class="btn-icon copy-api-key" onclick="copyValue(this, '{{ screen.api_key }}')" title="Copy API Key">üìã</button>
                                </div>
                            </div>
                            <div class="detail-item">
                                <label>API Endpoint</label>
                                <div class="detail-value">
                                    <code class="api-url">{{ screen.api_url }}</code>
                                    <button class="btn-icon copy-api-url" onclick="copyValue(this, BASE_URL + '{{ screen.api_url }}')" title="Copy API URL">üìã</button>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section">
                            <label>Custom Head HTML <span class="hint">(for Google Fonts, etc.)</span></label>
                            <textarea class="head-html-input" placeholder="<link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;>
<link href=&quot;https://fonts.googleapis.com/css2?family=...&quot; rel=&quot;stylesheet&quot;>" onclick="event.stopPropagation()">{{ screen.head_html or '' }}</textarea>
                            <p class="warning-text">Warning: Custom HTML including scripts is injected directly into your screen. Only add code from sources you trust.</p>
                            <button class="btn-secondary btn-save-head" onclick="saveHeadHtml('{{ screen.id }}', this); event.stopPropagation();">Save Head HTML</button>
                        </div>
                        <div class="detail-footer">
                            <div class="detail-timestamps">
                                <span>Created: <span class="created-time">{{ screen.created_display }}</span></span>
                                <span>Last Updated: <span class="updated-time">{{ screen.last_updated_display }}</span></span>
                            </div>
                            <div class="detail-actions">
                                <div class="action-dropdown">
                                    <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Copy Example ‚ñæ</button>
                                    <div class="dropdown-menu">
                                        <button onclick="copyExample(this, 'bash')">Bash / cURL</button>
                                        <button onclick="copyExample(this, 'python')">Python</button>
                                    </div>
                                </div>
                                <div class="action-dropdown">
                                    <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Screen Actions ‚ñæ</button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <button onclick="viewJson('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">View JSON</button>
                                        <button class="btn-debug" onclick="toggleDebug('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Toggle Debug</button>
                                        <button class="btn-reload" onclick="reloadScreen('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Reload Viewers</button>
                                        <button class="btn-duplicate" onclick="duplicateScreen('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Duplicate Screen</button>
                                        <button class="btn-save-template" onclick="openSaveTemplateModal('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Save as Template</button>
                                        <button class="btn-delete" onclick="deleteScreen('{{ screen.id }}', '{{ screen.api_key }}'); event.stopPropagation();">Delete Screen</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty">No screens yet. Create one to get started!</div>
            {% endif %}
        </div>

        {% if total_pages > 1 %}
        <div class="pagination">
            <span class="page-info">Page {{ page }} of {{ total_pages }} ({{ total_count }} screens)</span>
            <div class="page-controls">
                <a href="?page={{ page - 1 }}" class="btn-secondary{{ ' disabled' if page <= 1 else '' }}">‚Üê Previous</a>
                <a href="?page={{ page + 1 }}" class="btn-secondary{{ ' disabled' if page >= total_pages else '' }}">Next ‚Üí</a>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        const BASE_URL = window.location.origin;

        // Toast notification system
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            if (type === 'loading') {
                toast.innerHTML = `<div class="toast-spinner"></div><span>${message}</span>`;
            } else {
                const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '';
                toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            }

            container.appendChild(toast);

            // Return a function to dismiss this toast (for loading toasts)
            const dismiss = () => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            };

            if (type !== 'loading' && duration > 0) {
                setTimeout(dismiss, duration);
            }

            return dismiss;
        }

        // Helper to get Clerk session token for API calls (SaaS mode)
        // Returns empty headers in self-hosted mode where Clerk isn't loaded
        async function getAuthHeaders() {
            if (typeof Clerk === 'undefined') return {};

            // Wait for Clerk to be ready if needed
            if (!Clerk.loaded) await Clerk.load();
            if (!Clerk.session) return {};

            try {
                const token = await Clerk.session.getToken();
                if (token) {
                    return { 'Authorization': `Bearer ${token}` };
                }
            } catch (e) {
                console.error('[Auth] Error getting token:', e);
            }
            return {};
        }

        async function signOut() {
            if (typeof Clerk !== 'undefined' && Clerk.loaded) {
                await Clerk.signOut();
            }
            window.location.href = '/auth/logout';
        }

        // Open template selection modal when clicking Create New Screen
        document.getElementById('create-screen').addEventListener('click', () => {
            openTemplateModal();
        });

        // Template modal state
        let allTemplates = [];
        let filteredTemplates = [];
        let selectedTypeFilter = '';

        function openTemplateModal() {
            const modal = document.getElementById('template-modal');
            modal.style.display = 'flex';
            // Reset to options view
            document.querySelector('.template-options').style.display = 'flex';
            document.getElementById('template-gallery').style.display = 'none';
            // Reset filters
            selectedTypeFilter = '';
            document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.type-tab[data-type=""]').classList.add('active');
            document.getElementById('template-category-filter').value = '';
        }

        function closeTemplateModal() {
            document.getElementById('template-modal').style.display = 'none';
        }

        async function createBlankScreen() {
            closeTemplateModal();
            await createScreenWithTemplate(null);
        }

        async function createScreenWithTemplate(templateId) {
            const btn = document.getElementById('create-screen');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const authHeaders = await getAuthHeaders();
            let url = '/api/v1/screens';
            if (templateId) {
                url += `?template_id=${encodeURIComponent(templateId)}`;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: authHeaders,
                credentials: 'include'
            });

            btn.disabled = false;
            btn.textContent = originalText;

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                showToast(error.detail || 'Failed to create screen', 'error');
                return;
            }
            const data = await response.json();

            // Create and insert new screen card
            const screenList = document.querySelector('.screen-list');
            const emptyMessage = screenList.querySelector('.empty');
            if (emptyMessage) emptyMessage.remove();

            const card = createScreenCard(data);
            screenList.insertBefore(card, screenList.firstChild);
            card.classList.add('expanded');
            showToast(templateId ? 'Screen created from template' : 'Screen created', 'success');
        }

        async function showTemplateGallery() {
            document.querySelector('.template-options').style.display = 'none';
            document.getElementById('template-gallery').style.display = 'block';
            await loadTemplates();
        }

        function hideTemplateGallery() {
            document.querySelector('.template-options').style.display = 'flex';
            document.getElementById('template-gallery').style.display = 'none';
        }

        async function loadTemplates() {
            const grid = document.getElementById('template-grid');
            grid.innerHTML = '<div class="loading-templates">Loading templates...</div>';

            try {
                const authHeaders = await getAuthHeaders();
                const response = await fetch('/api/v1/templates?per_page=100', {
                    headers: authHeaders,
                    credentials: 'include'
                });

                if (!response.ok) {
                    grid.innerHTML = '<div class="template-empty">Failed to load templates</div>';
                    return;
                }

                const data = await response.json();
                allTemplates = data.templates || [];
                filterTemplates();
            } catch (error) {
                grid.innerHTML = '<div class="template-empty">Failed to load templates</div>';
            }
        }

        function setTypeFilter(btn, type) {
            // Update active tab
            document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            selectedTypeFilter = type;
            filterTemplates();
        }

        function filterTemplates() {
            const category = document.getElementById('template-category-filter').value;
            filteredTemplates = allTemplates.filter(t => {
                const matchesCategory = !category || t.category === category;
                const matchesType = !selectedTypeFilter || t.type === selectedTypeFilter;
                return matchesCategory && matchesType;
            });
            renderTemplates();
        }

        function renderTemplates() {
            const grid = document.getElementById('template-grid');

            if (filteredTemplates.length === 0) {
                const emptyMessage = selectedTypeFilter === 'user'
                    ? 'You haven\'t saved any templates yet. Use "Save as Template" on any screen to create one!'
                    : 'No templates available yet';
                grid.innerHTML = `<div class="template-empty">${emptyMessage}</div>`;
                return;
            }

            grid.innerHTML = filteredTemplates.map(template => `
                <div class="template-card" onclick="showTemplatePreview('${template.id}')">
                    <div class="template-thumbnail">
                        ${template.thumbnail_url
                            ? `<img src="${template.thumbnail_url}" alt="${template.name}">`
                            : `<div class="template-placeholder">${getCategoryIcon(template.category)}</div>`
                        }
                    </div>
                    <div class="template-info">
                        <span class="template-name">${escapeHtml(template.name)}</span>
                        <span class="template-category">${formatCategory(template.category)}</span>
                        ${template.description ? `<span class="template-desc">${escapeHtml(template.description)}</span>` : ''}
                    </div>
                    <span class="template-type-badge ${template.type}">${template.type === 'system' ? 'Built-in' : 'My Template'}</span>
                    ${template.type === 'user' ? `
                        <div class="template-actions" onclick="event.stopPropagation()">
                            <button class="template-action-btn" onclick="editTemplateMetadata('${template.id}')" title="Edit">
                                <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button class="template-action-btn btn-delete-template" onclick="deleteUserTemplate('${template.id}')" title="Delete">
                                <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getCategoryIcon(category) {
            const icons = {
                'restaurant': 'üçΩÔ∏è',
                'it_tech': 'üíª',
                'small_business': 'üè™',
                'education': 'üìö',
                'healthcare': 'üè•',
                'custom': '‚ú®'
            };
            return icons[category] || 'üìã';
        }

        function formatCategory(category) {
            const names = {
                'restaurant': 'Restaurant',
                'it_tech': 'IT / Tech',
                'small_business': 'Small Business',
                'education': 'Education',
                'healthcare': 'Healthcare',
                'custom': 'Custom'
            };
            return names[category] || category;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Template Preview
        let currentPreviewTemplateId = null;

        async function showTemplatePreview(templateId) {
            currentPreviewTemplateId = templateId;

            // Find in local array first (has basic info)
            const basicTemplate = allTemplates.find(t => t.id === templateId);
            if (!basicTemplate) {
                showToast('Template not found', 'error');
                return;
            }

            // Show loading state in modal
            const modal = document.getElementById('template-preview-modal');
            const content = document.getElementById('preview-content');
            content.innerHTML = '<div class="loading-templates">Loading template details...</div>';
            modal.style.display = 'flex';

            try {
                // Fetch full template details including configuration
                const authHeaders = await getAuthHeaders();
                const response = await fetch(`/api/v1/templates/${templateId}`, {
                    headers: authHeaders,
                    credentials: 'include'
                });

                if (!response.ok) {
                    content.innerHTML = '<div class="template-empty">Failed to load template details</div>';
                    return;
                }

                const template = await response.json();
                renderTemplatePreview(template);
            } catch (error) {
                content.innerHTML = '<div class="template-empty">Failed to load template details</div>';
            }
        }

        function renderTemplatePreview(template) {
            const content = document.getElementById('preview-content');

            // Extract widget types from configuration
            const widgetTypes = new Set();
            if (template.configuration && template.configuration.pages) {
                template.configuration.pages.forEach(page => {
                    if (page.content) {
                        page.content.forEach(item => {
                            if (item.type === 'widget' && item.widget_type) {
                                widgetTypes.add(item.widget_type);
                            }
                        });
                    }
                });
            }

            const widgetList = widgetTypes.size > 0
                ? Array.from(widgetTypes).map(w => `<span class="widget-tag">${formatWidgetName(w)}</span>`).join('')
                : '<span class="no-widgets">Basic text content</span>';

            content.innerHTML = `
                <div class="preview-layout">
                    <div class="preview-thumbnail">
                        ${template.thumbnail_url
                            ? `<img src="${template.thumbnail_url}" alt="${escapeHtml(template.name)}">`
                            : `<div class="preview-placeholder">${getCategoryIcon(template.category)}</div>`
                        }
                    </div>
                    <div class="preview-details">
                        <h3 class="preview-name">${escapeHtml(template.name)}</h3>
                        <span class="preview-category-badge">${formatCategory(template.category)}</span>
                        ${template.description
                            ? `<p class="preview-description">${escapeHtml(template.description)}</p>`
                            : '<p class="preview-description no-description">No description provided</p>'
                        }
                        <div class="preview-section">
                            <label>Included Widgets:</label>
                            <div class="widget-list">${widgetList}</div>
                        </div>
                        ${template.configuration && template.configuration.pages
                            ? `<div class="preview-section">
                                <label>Pages:</label>
                                <span class="page-count">${template.configuration.pages.length} page${template.configuration.pages.length !== 1 ? 's' : ''}</span>
                               </div>`
                            : ''
                        }
                    </div>
                </div>
            `;
        }

        function formatWidgetName(widget) {
            const names = {
                'clock': 'Clock',
                'weather': 'Weather',
                'stocks': 'Stocks',
                'rss': 'RSS Feed',
                'html': 'Custom HTML',
                'image': 'Image',
                'video': 'Video',
                'youtube': 'YouTube',
                'countdown': 'Countdown',
                'calendar': 'Calendar',
                'table': 'Table',
                'chart': 'Chart',
                'qrcode': 'QR Code',
                'text': 'Rich Text',
                'embed': 'Embed',
                'prometheus': 'Prometheus',
                'datadog': 'Datadog',
                'newrelic': 'New Relic',
                'grafana': 'Grafana'
            };
            return names[widget] || widget.charAt(0).toUpperCase() + widget.slice(1);
        }

        function closeTemplatePreview() {
            document.getElementById('template-preview-modal').style.display = 'none';
            currentPreviewTemplateId = null;
        }

        async function useSelectedTemplate() {
            if (!currentPreviewTemplateId) return;
            const templateId = currentPreviewTemplateId;  // Save before closing
            closeTemplatePreview();
            await selectTemplate(templateId);
        }

        async function selectTemplate(templateId) {
            closeTemplateModal();
            await createScreenWithTemplate(templateId);
        }

        // Edit/Delete Template Functions
        async function deleteUserTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) {
                return;
            }

            const dismiss = showToast('Deleting template...', 'loading');
            try {
                const authHeaders = await getAuthHeaders();
                const response = await fetch(`/api/v1/templates/${templateId}`, {
                    method: 'DELETE',
                    headers: authHeaders,
                    credentials: 'include'
                });

                dismiss();
                if (response.ok) {
                    // Remove from local array and re-render
                    allTemplates = allTemplates.filter(t => t.id !== templateId);
                    filterTemplates();
                    showToast('Template deleted', 'success');
                } else {
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to delete template', 'error');
                }
            } catch (error) {
                dismiss();
                showToast('Failed to delete template: ' + error.message, 'error');
            }
        }

        let editingTemplateId = null;

        async function editTemplateMetadata(templateId) {
            // Find the template in our local array
            const template = allTemplates.find(t => t.id === templateId);
            if (!template) {
                showToast('Template not found', 'error');
                return;
            }

            editingTemplateId = templateId;
            document.getElementById('edit-template-name').value = template.name || '';
            document.getElementById('edit-template-description').value = template.description || '';
            document.getElementById('edit-template-category').value = template.category || '';
            document.getElementById('edit-template-modal').style.display = 'flex';
        }

        function closeEditTemplateModal() {
            document.getElementById('edit-template-modal').style.display = 'none';
            editingTemplateId = null;
        }

        async function submitEditTemplate(event) {
            event.preventDefault();

            if (!editingTemplateId) return;

            const name = document.getElementById('edit-template-name').value.trim();
            const description = document.getElementById('edit-template-description').value.trim();
            const category = document.getElementById('edit-template-category').value;

            if (!name || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const btn = document.getElementById('update-template-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const authHeaders = await getAuthHeaders();
                const response = await fetch(`/api/v1/templates/${editingTemplateId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: name,
                        description: description || null,
                        category: category
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to update template', 'error');
                    return;
                }

                const updated = await response.json();
                // Update in local array
                const idx = allTemplates.findIndex(t => t.id === editingTemplateId);
                if (idx >= 0) {
                    allTemplates[idx] = { ...allTemplates[idx], ...updated };
                }
                filterTemplates();
                closeEditTemplateModal();
                showToast('Template updated', 'success');
            } catch (error) {
                showToast('Failed to update template: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }

        // Save Template Modal Functions
        let currentSaveTemplateScreenId = null;

        function openSaveTemplateModal(screenId, apiKey) {
            currentSaveTemplateScreenId = screenId;
            document.getElementById('template-screen-id').value = screenId;
            document.getElementById('template-name').value = '';
            document.getElementById('template-description').value = '';
            document.getElementById('template-category-select').value = '';
            document.getElementById('save-template-modal').style.display = 'flex';
        }

        function closeSaveTemplateModal() {
            document.getElementById('save-template-modal').style.display = 'none';
            currentSaveTemplateScreenId = null;
        }

        async function submitSaveTemplate(event) {
            event.preventDefault();

            const screenId = document.getElementById('template-screen-id').value;
            const name = document.getElementById('template-name').value.trim();
            const description = document.getElementById('template-description').value.trim();
            const category = document.getElementById('template-category-select').value;

            if (!name || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const btn = document.getElementById('save-template-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const authHeaders = await getAuthHeaders();
                const response = await fetch('/api/v1/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        screen_id: screenId,
                        name: name,
                        description: description || null,
                        category: category
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    showToast(error.detail || 'Failed to save template', 'error');
                    return;
                }

                const data = await response.json();
                closeSaveTemplateModal();
                showToast(`Template "${data.name}" saved successfully!`, 'success');
            } catch (error) {
                showToast('Failed to save template: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Template';
            }
        }

        function createScreenCard(data) {
            const template = document.getElementById('screen-card-template');
            const card = template.content.firstElementChild.cloneNode(true);

            const now = new Date().toISOString().slice(0, 19).replace('T', ' ');

            // Set data attributes
            card.dataset.screenId = data.screen_id;
            card.dataset.apiKey = data.api_key;
            card.dataset.screenUrl = data.screen_url;
            card.dataset.apiUrl = data.api_url;

            // Update content
            card.querySelector('.screen-id').textContent = data.screen_id;
            card.querySelector('.screen-link').href = data.screen_url;
            card.querySelector('.screen-link-text').textContent = data.screen_url;
            card.querySelector('.api-key').textContent = data.api_key;
            card.querySelector('.api-url').textContent = data.api_url;
            card.querySelector('.created-time').textContent = now;

            // Set screen name if provided
            const nameEl = card.querySelector('.screen-name');
            if (data.name && data.name !== 'Unnamed Screen') {
                nameEl.textContent = data.name;
                nameEl.classList.remove('unnamed');
            }

            // Update onclick handlers with actual values
            card.querySelector('.copy-api-key').onclick = function() { copyValue(this, data.api_key); };
            card.querySelector('.copy-api-url').onclick = function() { copyValue(this, BASE_URL + data.api_url); };
            card.querySelector('.btn-save-head').onclick = function(e) { e.stopPropagation(); saveHeadHtml(data.screen_id, this); };
            card.querySelector('.btn-view-json').onclick = function(e) { e.stopPropagation(); viewJson(data.screen_id, data.api_key); };
            card.querySelector('.btn-debug').onclick = function(e) { e.stopPropagation(); toggleDebug(data.screen_id, data.api_key); };
            card.querySelector('.btn-reload').onclick = function(e) { e.stopPropagation(); reloadScreen(data.screen_id, data.api_key); };
            card.querySelector('.btn-duplicate').onclick = function(e) { e.stopPropagation(); duplicateScreen(data.screen_id, data.api_key); };
            card.querySelector('.btn-save-template').onclick = function(e) { e.stopPropagation(); openSaveTemplateModal(data.screen_id, data.api_key); };
            card.querySelector('.btn-delete').onclick = function(e) { e.stopPropagation(); deleteScreen(data.screen_id, data.api_key); };

            return card;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.copy-dropdown') && !e.target.closest('.action-dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        function toggleExpand(card) {
            card.classList.toggle('expanded');
        }

        function toggleDropdown(btn) {
            const menu = btn.nextElementSibling;
            const wasOpen = menu.classList.contains('show');

            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                m.classList.remove('show');
            });

            // Toggle this one
            if (!wasOpen) {
                menu.classList.add('show');
            }
        }

        function toggleNavDropdown(btn) {
            const menu = btn.nextElementSibling;
            const wasOpen = menu.classList.contains('show');

            document.querySelectorAll('.nav-dropdown-menu.show').forEach(m => {
                m.classList.remove('show');
            });

            if (!wasOpen) {
                menu.classList.add('show');
            }
        }

        function getCardData(el) {
            const card = el.closest('.screen-card');
            return {
                screenId: card.dataset.screenId,
                apiKey: card.dataset.apiKey,
                screenUrl: card.dataset.screenUrl,
                apiUrl: card.dataset.apiUrl
            };
        }

        function copyValue(btn, value) {
            navigator.clipboard.writeText(value).then(() => {
                const original = btn.textContent;
                btn.textContent = '‚úì';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('copied');
                }, 1000);
            });
            event.stopPropagation();
        }

        function copyExample(btn, type) {
            const data = getCardData(btn);
            let text = '';

            if (type === 'bash') {
                text = `curl -X POST ${BASE_URL}${data.apiUrl} \\
  -H "Content-Type: application/json" \\
  -H "X-API-Key: ${data.apiKey}" \\
  -d '{"content": ["Hello, World!"]}'`;
            } else if (type === 'python') {
                text = `import requests

response = requests.post(
    "${BASE_URL}${data.apiUrl}",
    headers={"X-API-Key": "${data.apiKey}"},
    json={"content": ["Hello, World!"]}
)
print(response.json())`;
            }

            navigator.clipboard.writeText(text).then(() => {
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove('copied');
                    btn.closest('.dropdown-menu').classList.remove('show');
                }, 1000);
            });
            event.stopPropagation();
        }

        async function reloadScreen(screenId, apiKey) {
            const dismiss = showToast('Reloading viewers...', 'loading');
            try {
                const response = await fetch(`/api/v1/screens/${screenId}/reload`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                dismiss();
                const data = await response.json();
                if (response.ok) {
                    showToast(`Reload sent to ${data.viewers_reloaded} viewer(s)`, 'success');
                } else {
                    showToast('Failed to reload: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                dismiss();
                showToast('Failed to reload: ' + error.message, 'error');
            }
        }

        async function viewJson(screenId, apiKey) {
            const dismiss = showToast('Loading JSON...', 'loading');
            try {
                const response = await fetch(`/api/v1/screens/${screenId}/pages`, {
                    headers: { 'X-API-Key': apiKey }
                });
                dismiss();
                if (!response.ok) {
                    showToast('Failed to fetch screen data', 'error');
                    return;
                }
                const data = await response.json();
                const modal = document.getElementById('json-modal');
                const content = document.getElementById('json-content');
                content.textContent = JSON.stringify(data, null, 2);
                modal.style.display = 'flex';
            } catch (error) {
                dismiss();
                showToast('Failed to fetch: ' + error.message, 'error');
            }
        }

        function closeJsonModal() {
            document.getElementById('json-modal').style.display = 'none';
        }

        function copyJson() {
            const content = document.getElementById('json-content').textContent;
            navigator.clipboard.writeText(content);
            const btn = document.querySelector('#json-modal .btn-primary');
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy JSON', 1500);
        }

        async function toggleDebug(screenId, apiKey) {
            const dismiss = showToast('Toggling debug...', 'loading');
            try {
                // Server handles state - just send toggle request
                const response = await fetch(`/api/v1/screens/${screenId}/debug?enabled=toggle`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                dismiss();
                const data = await response.json();
                if (response.ok) {
                    showToast(`Debug ${data.debug_enabled ? 'enabled' : 'disabled'} for ${data.viewers} viewer(s)`, 'success');
                } else {
                    showToast('Failed to toggle debug: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                dismiss();
                showToast('Failed to toggle debug: ' + error.message, 'error');
            }
        }

        async function deleteScreen(screenId, apiKey) {
            if (!confirm('Are you sure you want to delete this screen? This action cannot be undone.')) {
                return;
            }

            const dismiss = showToast('Deleting screen...', 'loading');
            try {
                const response = await fetch(`/api/v1/screens/${screenId}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });
                dismiss();
                if (response.ok) {
                    // Remove card from DOM
                    const card = document.querySelector(`[data-screen-id="${screenId}"]`);
                    if (card) {
                        card.remove();
                        // Show empty message if no screens left
                        const screenList = document.querySelector('.screen-list');
                        if (!screenList.querySelector('.screen-card')) {
                            screenList.innerHTML = '<div class="empty">No screens yet. Create one to get started!</div>';
                        }
                    }
                    showToast('Screen deleted', 'success');
                } else {
                    const data = await response.json();
                    showToast('Failed to delete: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                dismiss();
                showToast('Failed to delete: ' + error.message, 'error');
            }
        }

        async function duplicateScreen(screenId, apiKey) {
            const dismiss = showToast('Duplicating screen...', 'loading');
            try {
                const response = await fetch(`/api/v1/screens/${screenId}/duplicate`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                dismiss();
                const data = await response.json();
                if (response.ok) {
                    // Create and insert new screen card
                    const screenList = document.querySelector('.screen-list');
                    const card = createScreenCard(data);
                    screenList.insertBefore(card, screenList.firstChild);
                    card.classList.add('expanded');
                    showToast('Screen duplicated', 'success');
                } else {
                    showToast('Failed to duplicate: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                dismiss();
                showToast('Failed to duplicate: ' + error.message, 'error');
            }
        }

        async function saveHeadHtml(screenId, btn) {
            const card = btn.closest('.screen-card');
            const apiKey = card.dataset.apiKey;
            const textarea = card.querySelector('.head-html-input');
            const headHtml = textarea.value;

            try {
                btn.disabled = true;
                btn.textContent = 'Saving...';

                const response = await fetch(`/api/v1/screens/${screenId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ head_html: headHtml })
                });

                if (response.ok) {
                    btn.textContent = 'Saved!';
                    showToast('Head HTML saved', 'success');
                    setTimeout(() => {
                        btn.textContent = 'Save Head HTML';
                        btn.disabled = false;
                    }, 1500);
                } else {
                    const data = await response.json();
                    showToast('Failed to save: ' + (data.detail || 'Unknown error'), 'error');
                    btn.textContent = 'Save Head HTML';
                    btn.disabled = false;
                }
            } catch (error) {
                showToast('Failed to save: ' + error.message, 'error');
                btn.textContent = 'Save Head HTML';
                btn.disabled = false;
            }
        }

        function editName(el, event) {
            event.stopPropagation();
            const card = el.closest('.screen-card');
            const screenId = card.dataset.screenId;
            const apiKey = card.dataset.apiKey;
            const currentName = el.classList.contains('unnamed') ? '' : el.textContent;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'name-input';
            input.value = currentName;
            input.placeholder = 'Enter screen name...';

            const saveName = async () => {
                const newName = input.value.trim();
                try {
                    const response = await fetch(`/api/v1/screens/${screenId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey
                        },
                        body: JSON.stringify({ name: newName || null })
                    });
                    if (response.ok) {
                        el.textContent = newName || 'Unnamed Screen';
                        el.classList.toggle('unnamed', !newName);
                    }
                } catch (error) {
                    console.error('Failed to update name:', error);
                }
                input.replaceWith(el);
            };

            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur();
                }
                if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });

            el.replaceWith(input);
            input.focus();
            input.select();
        }
    </script>

    <!-- Save Template Modal -->
    <div id="save-template-modal" class="modal" onclick="if(event.target === this) closeSaveTemplateModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save as Template</h2>
                <button class="modal-close" onclick="closeSaveTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="save-template-form" onsubmit="submitSaveTemplate(event)">
                    <input type="hidden" id="template-screen-id" value="">
                    <div class="form-group">
                        <label for="template-name">Template Name *</label>
                        <input type="text" id="template-name" required maxlength="100" placeholder="e.g., Restaurant Menu Board">
                    </div>
                    <div class="form-group">
                        <label for="template-description">Description</label>
                        <textarea id="template-description" maxlength="500" rows="3" placeholder="A brief description of what this template is for..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="template-category-select">Category *</label>
                        <select id="template-category-select" required>
                            <option value="">Select a category...</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="it_tech">IT / Tech</option>
                            <option value="small_business">Small Business</option>
                            <option value="education">Education</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSaveTemplateModal()">Cancel</button>
                <button class="btn-primary" id="save-template-btn" onclick="submitSaveTemplate(event)">Save Template</button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="edit-template-modal" class="modal" onclick="if(event.target === this) closeEditTemplateModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Template</h2>
                <button class="modal-close" onclick="closeEditTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-template-form" onsubmit="submitEditTemplate(event)">
                    <div class="form-group">
                        <label for="edit-template-name">Template Name *</label>
                        <input type="text" id="edit-template-name" required maxlength="100" placeholder="e.g., Restaurant Menu Board">
                    </div>
                    <div class="form-group">
                        <label for="edit-template-description">Description</label>
                        <textarea id="edit-template-description" maxlength="500" rows="3" placeholder="A brief description of what this template is for..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-template-category">Category *</label>
                        <select id="edit-template-category" required>
                            <option value="">Select a category...</option>
                            <option value="restaurant">Restaurant</option>
                            <option value="it_tech">IT / Tech</option>
                            <option value="small_business">Small Business</option>
                            <option value="education">Education</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditTemplateModal()">Cancel</button>
                <button class="btn-primary" id="update-template-btn" onclick="submitEditTemplate(event)">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div id="template-preview-modal" class="modal" onclick="if(event.target === this) closeTemplatePreview()">
        <div class="modal-content modal-preview">
            <div class="modal-header">
                <h2>Template Preview</h2>
                <button class="modal-close" onclick="closeTemplatePreview()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="preview-content">
                    <div class="loading-templates">Loading template details...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeTemplatePreview()">Cancel</button>
                <button class="btn-primary" onclick="useSelectedTemplate()">Use This Template</button>
            </div>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div id="template-modal" class="modal" onclick="if(event.target === this) closeTemplateModal()">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Create New Screen</h2>
                <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-options">
                    <button class="template-option-btn" onclick="createBlankScreen()">
                        <span class="option-icon">üìÑ</span>
                        <span class="option-title">Start from Scratch</span>
                        <span class="option-desc">Create a blank screen</span>
                    </button>
                    <button class="template-option-btn" onclick="showTemplateGallery()">
                        <span class="option-icon">üé®</span>
                        <span class="option-title">Use a Template</span>
                        <span class="option-desc">Start with a pre-built layout</span>
                    </button>
                </div>
                <div id="template-gallery" class="template-gallery" style="display: none;">
                    <div class="gallery-header">
                        <button class="btn-secondary btn-back" onclick="hideTemplateGallery()">‚Üê Back</button>
                        <div class="gallery-filters">
                            <div class="type-tabs">
                                <button class="type-tab active" data-type="" onclick="setTypeFilter(this, '')">All</button>
                                <button class="type-tab" data-type="system" onclick="setTypeFilter(this, 'system')">System</button>
                                <button class="type-tab" data-type="user" onclick="setTypeFilter(this, 'user')">My Templates</button>
                            </div>
                            <div class="category-filter">
                                <select id="template-category-filter" onchange="filterTemplates()">
                                    <option value="">All Categories</option>
                                    <option value="restaurant">Restaurant</option>
                                    <option value="it_tech">IT / Tech</option>
                                    <option value="small_business">Small Business</option>
                                    <option value="education">Education</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="template-grid" class="template-grid">
                        <div class="loading-templates">Loading templates...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON View Modal -->
    <div id="json-modal" class="modal" onclick="if(event.target === this) closeJsonModal()">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Screen Data (JSON)</h2>
                <button class="modal-close" onclick="closeJsonModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="json-content" class="json-display"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeJsonModal()">Close</button>
                <button class="btn-primary" onclick="copyJson()">Copy JSON</button>
            </div>
        </div>
    </div>

    <!-- Template for new screen cards (cloned by JavaScript) -->
    <template id="screen-card-template">
        <div class="screen-card">
            <div class="card-header" onclick="toggleExpand(this.parentElement)">
                <div class="card-summary">
                    <span class="screen-name unnamed" onclick="editName(this, event)" title="Click to edit name">Unnamed Screen</span>
                    <code class="screen-id"></code>
                    <a href="#" target="_blank" class="screen-link" onclick="event.stopPropagation()">
                        <span class="link-icon">‚Üó</span> <span class="screen-link-text"></span>
                    </a>
                    <span class="viewer-badge">0 viewers</span>
                </div>
                <span class="expand-icon">‚ñº</span>
            </div>
            <div class="card-details">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>API Key</label>
                        <div class="detail-value">
                            <code class="api-key"></code>
                            <button class="btn-icon copy-api-key" title="Copy API Key">üìã</button>
                        </div>
                    </div>
                    <div class="detail-item">
                        <label>API Endpoint</label>
                        <div class="detail-value">
                            <code class="api-url"></code>
                            <button class="btn-icon copy-api-url" title="Copy API URL">üìã</button>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <label>Custom Head HTML <span class="hint">(for Google Fonts, etc.)</span></label>
                    <textarea class="head-html-input" placeholder="<link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;>
<link href=&quot;https://fonts.googleapis.com/css2?family=...&quot; rel=&quot;stylesheet&quot;>" onclick="event.stopPropagation()"></textarea>
                    <p class="warning-text">Warning: Custom HTML including scripts is injected directly into your screen. Only add code from sources you trust.</p>
                    <button class="btn-secondary btn-save-head">Save Head HTML</button>
                </div>
                <div class="detail-footer">
                    <div class="detail-timestamps">
                        <span>Created: <span class="created-time"></span></span>
                        <span>Last Updated: <span class="updated-time">Never</span></span>
                    </div>
                    <div class="detail-actions">
                        <div class="action-dropdown">
                            <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Copy Example ‚ñæ</button>
                            <div class="dropdown-menu">
                                <button onclick="copyExample(this, 'bash')">Bash / cURL</button>
                                <button onclick="copyExample(this, 'python')">Python</button>
                            </div>
                        </div>
                        <div class="action-dropdown">
                            <button class="btn-secondary" onclick="toggleDropdown(this); event.stopPropagation();">Screen Actions ‚ñæ</button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <button class="btn-view-json">View JSON</button>
                                <button class="btn-debug">Toggle Debug</button>
                                <button class="btn-reload">Reload Viewers</button>
                                <button class="btn-duplicate">Duplicate Screen</button>
                                <button class="btn-save-template">Save as Template</button>
                                <button class="btn-delete">Delete Screen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    {% include 'partials/footer.html' %}

    <!-- Help Button -->
    <div class="help-container">
        <span class="help-text">{{ help_text }}</span>
        <a href="{{ help_url }}" target="_blank" class="help-button" title="Get Help">?</a>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <style>
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 350px;
        }
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        .toast.loading { background: #3b82f6; }
        .toast-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }

        /* Save Template Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-size: 0.9rem;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #16213e;
            border: 1px solid #2a2a4e;
            border-radius: 6px;
            color: #eaeaea;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn-save-template {
            color: #9b59b6;
        }

        .btn-save-template:hover {
            background: rgba(155, 89, 182, 0.1);
        }

        /* Template Modal Styles */
        .template-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding: 1rem;
        }

        .template-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem 3rem;
            background: #1a1a2e;
            border: 2px solid #2a2a4e;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
        }

        .template-option-btn:hover {
            border-color: #3498db;
            background: #1e2340;
            transform: translateY(-2px);
        }

        .template-option-btn .option-icon {
            font-size: 2.5rem;
        }

        .template-option-btn .option-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #eaeaea;
        }

        .template-option-btn .option-desc {
            font-size: 0.85rem;
            color: #888;
        }

        .template-gallery {
            padding: 1rem;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .gallery-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .type-tabs {
            display: flex;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 4px;
            gap: 2px;
        }

        .type-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .type-tab:hover {
            color: #eaeaea;
            background: rgba(255,255,255,0.05);
        }

        .type-tab.active {
            background: #3498db;
            color: white;
        }

        .btn-back {
            padding: 0.5rem 1rem;
        }

        .category-filter select {
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border: 1px solid #2a2a4e;
            border-radius: 6px;
            color: #eaeaea;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .category-filter select:focus {
            outline: none;
            border-color: #3498db;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .template-card {
            background: #1a1a2e;
            border: 2px solid #2a2a4e;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .template-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .template-thumbnail {
            height: 120px;
            background: #16213e;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .template-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-placeholder {
            font-size: 3rem;
            opacity: 0.5;
        }

        .template-info {
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .template-name {
            font-weight: 600;
            color: #eaeaea;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-category {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .template-desc {
            font-size: 0.8rem;
            color: #aaa;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .template-type-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .template-type-badge.system {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .template-type-badge.user {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .template-actions {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .template-card:hover .template-actions {
            opacity: 1;
        }

        .template-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .template-action-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .template-action-btn.btn-delete-template:hover {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .loading-templates, .template-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        /* Template Preview Modal */
        #template-preview-modal {
            z-index: 1100;  /* Higher than template-modal so it appears on top */
        }

        .modal-preview {
            max-width: 600px;
        }

        .preview-layout {
            display: flex;
            gap: 1.5rem;
        }

        .preview-thumbnail {
            flex: 0 0 200px;
            height: 150px;
            background: #16213e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-placeholder {
            font-size: 4rem;
            opacity: 0.5;
        }

        .preview-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .preview-name {
            margin: 0;
            font-size: 1.3rem;
            color: #eaeaea;
        }

        .preview-category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            width: fit-content;
        }

        .preview-description {
            color: #aaa;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0;
        }

        .preview-description.no-description {
            color: #666;
            font-style: italic;
        }

        .preview-section {
            margin-top: 0.5rem;
        }

        .preview-section label {
            display: block;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .widget-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .widget-tag {
            padding: 0.25rem 0.6rem;
            background: #1a1a2e;
            border: 1px solid #2a2a4e;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #ccc;
        }

        .no-widgets {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }

        .page-count {
            color: #ccc;
            font-size: 0.95rem;
        }

        @media (max-width: 600px) {
            .preview-layout {
                flex-direction: column;
            }
            .preview-thumbnail {
                flex: none;
                width: 100%;
                height: 120px;
            }
        }

        @media (max-width: 600px) {
            .template-options {
                flex-direction: column;
            }
            .template-option-btn {
                min-width: auto;
                padding: 1.5rem;
            }
            .gallery-header {
                flex-direction: column;
                align-items: stretch;
            }
            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</body>
</html>
